name: AIè¦‹ç©ã‚‚ã‚Š
on:
  issues:
    types: [opened, edited]

jobs:
  estimate:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Estimate with AI
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # ãƒªãƒˆãƒ©ã‚¤è¨­å®šã‚’è¿½åŠ 
          retries: 3
          script: |
            try {
              const issueBody = context.payload.issue.body || '';
              const issueTitle = context.payload.issue.title || '';
              
              // å…¥åŠ›æ¤œè¨¼
              if (!issueTitle.trim() && !issueBody.trim()) {
                console.log('Issue title and body are both empty, skipping estimation');
                return;
              }
              
              // å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼
              const requiredSecrets = ['${{ secrets.AZURE_OPENAI_ENDPOINT }}', '${{ secrets.AZURE_OPENAI_API_KEY }}'];
              if (!requiredSecrets[0] || !requiredSecrets[1]) {
                throw new Error('Required Azure OpenAI secrets are not configured');
              }
              
              // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
              const defaultPrompt = 'ã‚ãªãŸã¯çµŒé¨“è±Šå¯ŒãªWEBã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®issueã‚’æŠ€è¡“çš„ãªè¦³ç‚¹ã§åˆ†æã—ã€å®Ÿè£…ã«å¿…è¦ãªå·¥æ•°ã‚’JSONå½¢å¼ã§è¦‹ç©ã‚‚ã£ã¦ãã ã•ã„ã€‚\n\nå‡ºåŠ›å½¢å¼:\n{\n  "estimateHours": è¦‹ç©ã‚‚ã‚Šæ™‚é–“ï¼ˆæ•°å€¤ï¼‰,\n  "rationale": "æŠ€è¡“çš„ãªå®Ÿè£…é›£æ˜“åº¦ã€å¿…è¦ãªèª¿æŸ»ãƒ»è¨­è¨ˆæ™‚é–“ã€ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ™‚é–“ã€ãƒ†ã‚¹ãƒˆæ™‚é–“ãªã©ã®æ ¹æ‹ ",\n  "risks": ["æŠ€è¡“çš„ãƒªã‚¹ã‚¯ã‚„å®Ÿè£…ä¸Šã®èª²é¡Œ"],\n  "complexity": "low/medium/high",\n  "confidence": "low/medium/high"\n}\n\nã‚¿ã‚¤ãƒˆãƒ«: {{title}}\n\nå†…å®¹: {{body}}';
              
              const promptTemplate = process.env.ESTIMATION_PROMPT || defaultPrompt;
              
              const prompt = promptTemplate
                .replace('{{title}}', issueTitle)
                .replace('{{body}}', issueBody);
              
              // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®é•·ã•åˆ¶é™ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™å¯¾ç­–ï¼‰
              const maxPromptLength = 8000;
              const truncatedPrompt = prompt.length > maxPromptLength 
                ? prompt.substring(0, maxPromptLength) + '...'
                : prompt;
              
              console.log(`Making API request for issue #${context.issue.number}`);
              
              // Azure OpenAI APIã‚’å‘¼ã³å‡ºã—ã¦è¦‹ç©ã‚‚ã‚Šã‚’å–å¾—
              const apiVersion = process.env.AZURE_OPENAI_API_VERSION || '2024-02-01';
              const modelName = process.env.AZURE_OPENAI_MODEL || 'gpt-4o-mini';
              
              const controller = new AbortController();
              const timeoutId = setTimeout(() => controller.abort(), 30000);
              
              const response = await fetch('${{ secrets.AZURE_OPENAI_ENDPOINT }}?api-version=' + apiVersion, {
                method: 'POST',
                headers: {
                  'api-key': '${{ secrets.AZURE_OPENAI_API_KEY }}',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  messages: [{
                    role: 'user',
                    content: truncatedPrompt
                  }],
                  max_tokens: 800,
                  temperature: 0.1,
                  top_p: 0.95
                }),
                signal: controller.signal
              });
              
              clearTimeout(timeoutId);
              
              if (!response.ok) {
                const errorText = await response.text();
                console.error(`Azure OpenAI API error: ${response.status} - ${errorText}`);
                throw new Error(`Azure OpenAI API error: ${response.status}`);
              }
              
              const data = await response.json();
              
              if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throw new Error('Invalid response format from Azure OpenAI API');
              }
              
              const estimate = data.choices[0].message.content.trim();
              console.log(`AI estimation result: ${estimate}`);
              
              // JSONå½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹
              let estimationData;
              try {
                // JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡ºã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 
                const jsonMatch = estimate.match(/\{[\s\S]*\}/);
                const jsonString = jsonMatch ? jsonMatch[0] : estimate;
                estimationData = JSON.parse(jsonString);
              } catch (parseError) {
                console.log('Failed to parse JSON response, attempting to extract numeric estimate');
                // JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã¯å¾“æ¥é€šã‚Šæ•°å€¤æŠ½å‡ºã‚’è©¦è¡Œ
                const numericEstimate = parseFloat(estimate);
                if (!isNaN(numericEstimate) && numericEstimate > 0) {
                  estimationData = {
                    estimateHours: numericEstimate,
                    rationale: "è©³ç´°ãªåˆ†æçµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ",
                    risks: ["åˆ†æçµæœãŒä¸å®Œå…¨ã§ã™"],
                    complexity: "unknown",
                    confidence: "low"
                  };
                } else {
                  estimationData = null;
                }
              }
              
              let commentBody;
              if (estimationData && estimationData.estimateHours && !isNaN(estimationData.estimateHours)) {
                const complexityEmoji = {
                  'low': 'ğŸŸ¢',
                  'medium': 'ğŸŸ¡', 
                  'high': 'ğŸ”´',
                  'unknown': 'âšª'
                };
                
                const confidenceEmoji = {
                  'low': 'ğŸ“‰',
                  'medium': 'ğŸ“Š',
                  'high': 'ğŸ“ˆ',
                  'unknown': 'â“'
                };
                
                commentBody = 'ğŸ¤– **AIå·¥æ•°è¦‹ç©ã‚‚ã‚Šçµæœ**\n\n';
                commentBody += '## ğŸ“Š è¦‹ç©ã‚‚ã‚Šæ™‚é–“\n';
                commentBody += `**${estimationData.estimateHours}æ™‚é–“**\n\n`;
                commentBody += '## ğŸ“ è¦‹ç©ã‚‚ã‚Šæ ¹æ‹ \n';
                commentBody += `${estimationData.rationale || 'æ ¹æ‹ ã®è©³ç´°ã¯å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'}\n\n`;
                commentBody += '## âš ï¸ æƒ³å®šãƒªã‚¹ã‚¯\n';
                
                if (estimationData.risks && Array.isArray(estimationData.risks) && estimationData.risks.length > 0) {
                  estimationData.risks.forEach((risk, index) => {
                    commentBody += `${index + 1}. ${risk}\n`;
                  });
                } else {
                  commentBody += '- ç‰¹å®šã®ãƒªã‚¹ã‚¯ã¯è­˜åˆ¥ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ\n';
                }
                
                commentBody += '\n## ğŸ“ˆ åˆ†æãƒ¡ã‚¿æƒ…å ±\n';
                commentBody += `- **è¤‡é›‘åº¦**: ${complexityEmoji[estimationData.complexity] || 'âšª'} ${estimationData.complexity || 'unknown'}\n`;
                commentBody += `- **ä¿¡é ¼åº¦**: ${confidenceEmoji[estimationData.confidence] || 'â“'} ${estimationData.confidence || 'unknown'}\n\n`;
                commentBody += '---\n';
                commentBody += '*ã“ã®è¦‹ç©ã‚‚ã‚Šã¯AIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å‚è€ƒç¨‹åº¦ã«ã”åˆ©ç”¨ãã ã•ã„ã€‚*';
              } else {
                commentBody = 'ğŸ¤– **AIå·¥æ•°è¦‹ç©ã‚‚ã‚Š**: è¦‹ç©ã‚‚ã‚ŠãŒå›°é›£ã§ã™\n\n';
                commentBody += `çµæœ: ${estimate}\n\n`;
                commentBody += '*æ•°å€¤ã§ã®è¦‹ç©ã‚‚ã‚ŠãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚issueã®å†…å®¹ã‚’ã‚ˆã‚Šè©³ç´°ã«è¨˜è¿°ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚*';
              }
              
              // issueã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¦‹ç©ã‚‚ã‚Šã‚’è¿½åŠ 
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
              
              console.log(`Successfully added estimation comment to issue #${context.issue.number}`);
              
            } catch (error) {
              console.error('Error in AI estimation workflow:', error);
              
              // ã‚¨ãƒ©ãƒ¼æ™‚ã«ã‚‚ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆãŸã ã—APIã‚¨ãƒ©ãƒ¼ã§ãªã„å ´åˆã®ã¿ï¼‰
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: 'ğŸš¨ **AIå·¥æ•°è¦‹ç©ã‚‚ã‚Šã‚¨ãƒ©ãƒ¼**\n\nè¦‹ç©ã‚‚ã‚Šã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n*ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚*'
                });
              } catch (commentError) {
                console.error('Failed to add error comment:', commentError);
              }
              
              // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è‡ªä½“ã¯å¤±æ•—ã•ã›ã‚‹
              throw error;
            }
        env:
          ESTIMATION_PROMPT: ${{ vars.ESTIMATION_PROMPT }}
          AZURE_OPENAI_API_VERSION: ${{ vars.AZURE_OPENAI_API_VERSION }}
          AZURE_OPENAI_MODEL: ${{ vars.AZURE_OPENAI_MODEL }}